<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Organ Drag & Drop</title>
    <style>
        body { margin: 0; overflow: hidden; background: #eee; }
        canvas { display: block; }
    </style>
</head>
<body>
<script type="module">
    // âœ… Import Three.js & GLTFLoader from full URLs (no "three" package name)
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';

    let scene, camera, renderer, raycaster, mouse;
    let dragging = false;
    let selectedObject = null;
    let organs = [];
    let loader;

    init();
    loadModel();
    animate();

    function init() {
        loader = new GLTFLoader();

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        let hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
        hemiLight.position.set(0, 20, 0);
        scene.add(hemiLight);

        let dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();

        window.addEventListener('resize', onWindowResize);
        window.addEventListener('mousedown', onMouseDown);
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
    }

    function loadModel() {
        loader.load('Tools/organ_drag_drop_trial.glb',
            function (gltf) {
                let model = gltf.scene;
                scene.add(model);

                model.traverse(function (child) {
                    if (child.isMesh) {
                        child.name = child.name.trim();

                        if (child.name === "left_belly" || child.name === "right_belly") {
                            child.userData.type = "belly";
                        }
                        else if (["lungs", "intestine", "heart", "gall bladder"].includes(child.name.toLowerCase())) {
                            child.userData.type = "organ";
                            organs.push(child);
                        }
                    }
                });
            },
            undefined,
            function (error) {
                console.error('Error loading model:', error);
            }
        );
    }

    function onMouseDown(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        let intersects = raycaster.intersectObjects(scene.children, true);

        if (intersects.length > 0) {
            let clicked = intersects[0].object;

            if (clicked.userData?.type === "belly") {
                clicked.visible = false;
            }
            else if (clicked.userData?.type === "organ") {
                selectedObject = clicked;
                dragging = true;
            }
        }
    }

    function onMouseMove(event) {
        if (dragging && selectedObject) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            let planeZ = new THREE.Plane(new THREE.Vector3(0, 0, 1), -1);
            let intersection = new THREE.Vector3();
            raycaster.ray.intersectPlane(planeZ, intersection);
            selectedObject.position.copy(intersection);
        }
    }

    function onMouseUp(event) {
        if (dragging && selectedObject) {
            if (event.clientX > window.innerWidth * 0.75) {
                console.log(selectedObject.name + " dropped in side area");
            }
            dragging = false;
            selectedObject = null;
        }
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }
</script>
</body>
</html>
